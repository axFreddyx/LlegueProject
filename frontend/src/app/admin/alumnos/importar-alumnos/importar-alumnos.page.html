<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/ver/alumnos" text="Regresar"></ion-back-button>
    </ion-buttons>
    <ion-title>Importar Alumnos</ion-title>
  </ion-toolbar>

  <!-- Tabs -->
  <ion-toolbar class="tabs-toolbar">
    <ion-segment [(ngModel)]="selectedTab">
      <ion-segment-button value="plantilla">
        <ion-label>Plantilla</ion-label>
      </ion-segment-button>
      <ion-segment-button value="salones">
        <ion-label>Salones <ion-badge *ngIf="totalSalones">{{ totalSalones }}</ion-badge></ion-label>
      </ion-segment-button>
      <ion-segment-button value="importar">
        <ion-label>Importar <ion-badge *ngIf="totalFilasPreview || totalErroresPreview">{{ totalFilasPreview || 0 }}/{{ totalErroresPreview || 0 }}</ion-badge></ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- ===== Pestaña: PLANTILLA ===== -->
  <ng-container *ngIf="selectedTab === 'plantilla'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Formato de la plantilla</ion-card-title>
        <ion-card-subtitle>Usa <code>salon_documentId</code> si quieres asignar salón</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ol class="pasos">
          <li>Descarga la plantilla.</li>
          <li>Ve a <b>Salones</b> y copia el <b>DocumentID</b> que necesitas.</li>
          <li>Pega ese valor en <code>salon_documentId</code> de tu Excel (opcional).</li>
          <li>Ve a <b>Importar</b>, sube el archivo y confirma.</li>
        </ol>

        <ion-item lines="none" class="info-callout">
          <ion-icon name="information-circle-outline" slot="start"></ion-icon>
          <ion-label>
            Encabezados exactos: <code>nombre, apellidos, salon_documentId</code>.<br/>
            <b>Obligatorios:</b> <code>nombre</code>, <code>apellidos</code>.<br/>
            <b>Opcional:</b> <code>salon_documentId</code>. Si no se indica o no existe, el alumno se crea sin salón.
          </ion-label>
        </ion-item>

        <ion-grid class="ion-margin-top">
          <ion-row class="ion-justify-content-start ion-align-items-center">
            <ion-col size="12" size-md="6" size-lg="4">
              <ion-button expand="block" (click)="descargarPlantilla()">
                <ion-icon name="download-outline" slot="start"></ion-icon>
                Descargar plantilla
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>

        <div class="tabla-scroll modal-table">
          <table class="tabla-ejemplo">
            <thead>
              <tr>
                <th>nombre</th><th>apellidos</th><th>salon_documentId</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Ana</td><td>Pérez</td><td>pega aquí el documentId (opcional)</td></tr>
              <tr><td>Luis</td><td>Gómez</td><td>(opcional)</td></tr>
            </tbody>
          </table>
        </div>
      </ion-card-content>
    </ion-card>
  </ng-container>

  <!-- ===== Pestaña: SALONES ===== -->
  <ng-container *ngIf="selectedTab === 'salones'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Salones disponibles</ion-card-title>
        <ion-card-subtitle>Copia el <b>DocumentID</b> y pégalo en tu Excel</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-item lines="full">
          <ion-icon name="search-outline" slot="start"></ion-icon>
          <ion-input [(ngModel)]="filtroSalon" placeholder="Buscar por grado, grupo, aula, ID o documentId"></ion-input>
        </ion-item>

        <ion-item lines="none" class="warning-callout" *ngIf="salones.length === 0">
          <ion-icon name="alert-circle-outline" slot="start"></ion-icon>
          <ion-label>No se encontraron salones. Crea salones primero en el sistema.</ion-label>
        </ion-item>

        <div class="tabla-scroll modal-table" *ngIf="salonesFiltrados.length">
          <table class="tabla-salones">
            <thead>
              <tr>
                <th>ID</th>
                <th>DocumentID</th>
                <th>Grado</th>
                <th>Grupo</th>
                <th>Aula</th>
                <!-- Se quita columna "Total" -->
                <th>Acción</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let s of salonesFiltrados">
                <td>{{s.id}}</td>
                <td><code>{{s.documentId}}</code></td>
                <td>{{s.grado === null ? '—' : s.grado}}</td>
                <td>{{s.grupo || '—'}}</td>
                <td>{{s.aula || '—'}}</td>
                <td>
                  <ion-button size="small" fill="clear" (click)="copyToClipboard(s.documentId)">
                    Copiar ID
                  </ion-button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <ion-item lines="none" class="hint" *ngIf="salonesFiltrados.length">
          <ion-icon name="bulb-outline" slot="start"></ion-icon>
          <ion-label>
            Si el Admin de Strapi no muestra la columna de salón, configúrala en <i>Content Manager → Configure the view</i>.
          </ion-label>
        </ion-item>
      </ion-card-content>
    </ion-card>
  </ng-container>

  <!-- ===== Pestaña: IMPORTAR ===== -->
  <ng-container *ngIf="selectedTab === 'importar'">
    <!-- Subir archivo -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Subir archivo</ion-card-title>
        <ion-card-subtitle>Acepta .xlsx, .xls o .csv</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label>Archivo</ion-label>
          <input type="file" accept=".xlsx,.xls,.csv" (change)="onFileChange($event)" />
        </ion-item>

        <ion-button expand="block" (click)="importar()" [disabled]="!filas.length || cargando">
          {{ cargando ? 'Importando…' : 'Importar' }}
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Preview con validación de salon_documentId -->
    <ion-card *ngIf="filas.length">
      <ion-card-header>
        <ion-card-title>Vista previa ({{filas.length}} filas)</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div *ngIf="erroresPreview.length" class="ion-margin-bottom">
          <ion-item color="danger" *ngFor="let e of erroresPreview">{{e}}</ion-item>
        </div>

        <div class="tabla-scroll">
          <table class="tabla-preview">
            <thead>
              <tr>
                <th>#</th>
                <th>Nombre</th>
                <th>Apellidos</th>
                <th>salon_documentId</th>
                <th>Validez del salón</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let f of filas; let i = index">
                <td>{{i+2}}</td>
                <td>{{f.nombre}}</td>
                <td>{{f.apellidos}}</td>
                <td>{{f.salon_documentId || '—'}}</td>
                <td>
                  <ion-badge *ngIf="isSalonDocPresent(f) && isSalonDocValid(f)" color="success">Existe</ion-badge>
                  <ion-badge *ngIf="isSalonDocPresent(f) && !isSalonDocValid(f)" color="warning">No existe</ion-badge>
                  <span *ngIf="!isSalonDocPresent(f)">—</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Resumen -->
    <ion-card *ngIf="resumen">
      <ion-card-header>
        <ion-card-title>Resultado</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p><b>Correctos:</b> {{resumen.ok}}</p>
        <p><b>Errores:</b> {{resumen.fail}}</p>
        <ion-list *ngIf="resumen.errores.length">
          <ion-item *ngFor="let e of resumen.errores">
            Fila {{e.fila}} — {{e.motivo}}
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </ng-container>

</ion-content>
